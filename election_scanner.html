<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Department Election — Scanner</title>
<!-- ZXing for barcode camera scanning -->
<script src="https://unpkg.com/@zxing/library@0.19.1/umd/index.min.js"></script>
<!-- PapaParse for CSV parsing/export -->
<script src="https://unpkg.com/papaparse@5.4.1/papaparse.min.js"></script>
<style>
  :root{--bg:#0f172a;--card:#0b1220;--accent:#06b6d4;--muted:#94a3b8; color-scheme: dark;}
  html,body{height:100%;margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,"Helvetica Neue",Arial;background:linear-gradient(180deg,#071028 0%, #08132b 100%);color:#e6eef6}
  .container{max-width:980px;margin:20px auto;padding:18px}
  header{display:flex;align-items:center;gap:12px}
  h1{margin:0;font-size:20px}
  .card{background:rgba(255,255,255,0.03);padding:14px;border-radius:12px;box-shadow:0 6px 18px rgba(2,6,23,0.6);margin-top:12px}
  .row{display:flex;gap:12px;flex-wrap:wrap}
  button{background:var(--accent);border:none;padding:8px 12px;border-radius:8px;color:#001;cursor:pointer;font-weight:600}
  button.ghost{background:transparent;border:1px solid rgba(255,255,255,0.06);color:var(--muted)}
  input[type=file]{color:transparent}
  .small{font-size:13px;color:var(--muted)}
  #video{width:100%;border-radius:8px;background:#000;height:260px;object-fit:cover}
  .info{padding:8px;border-radius:8px;background:rgba(255,255,255,0.02)}
  table{width:100%;border-collapse:collapse;margin-top:10px;font-size:13px}
  th,td{padding:8px;text-align:left;border-bottom:1px solid rgba(255,255,255,0.03)}
  .status-ok{color:#6ee7b7;font-weight:700}
  .status-no{color:#fca5a5;font-weight:700}
  .controls{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
  .tiny{font-size:12px;padding:6px 8px;border-radius:8px}
  .muted{color:var(--muted)}
  .flex-between{display:flex;justify-content:space-between;gap:12px;align-items:center}
  .center{display:flex;align-items:center;gap:8px}
  footer{margin-top:16px;font-size:12px;color:var(--muted)}
  @media(min-width:880px){#video{height:360px}}
</style>
</head>
<body>
<div class="container">
  <header>
    <div style="width:48px;height:48px;border-radius:10px;background:linear-gradient(135deg,var(--accent),#7c3aed);display:flex;align-items:center;justify-content:center;font-weight:800">EC</div>
    <div>
      <h1>Dept Election — Scanner & Register</h1>
      <div class="small muted">Scan ID card barcode → check eligibility → register vote (single click)</div>
    </div>
  </header>

  <section class="card">
    <div class="row">
      <div style="flex:1;min-width:260px">
        <div class="small">1) Upload voters CSV (one-time) — Enrollment must match barcode value</div>
        <div style="margin-top:8px" class="center">
          <label class="tiny ghost" for="fileInput" style="padding:8px 10px;cursor:pointer">Choose CSV</label>
          <input id="fileInput" type="file" accept=".csv,text/csv" />
          <button id="loadSample" class="tiny">Load sample CSV</button>
          <button id="clearData" class="tiny">Clear data</button>
        </div>
        <div class="small muted" style="margin-top:8px">CSV headers: <code>Enrollment,Name,Dept,Eligible,Voted,VotedTime,ScannerID,Notes</code></div>
      </div>

      <div style="flex:1;min-width:260px">
        <div class="small">2) Scanner device / Booth ID</div>
        <input id="boothId" class="tiny" placeholder="Booth-1 (optional)" style="margin-top:8px;width:100%" />
        <div class="small muted" style="margin-top:6px">Operator: stored in audit if browser supports.</div>
      </div>
    </div>
  </section>

  <section class="card" style="margin-top:14px">
    <div class="flex-between">
      <div>
        <div class="small">3) Camera scanner</div>
        <div class="small muted">Allow camera permission, then tap Start to begin scanning.</div>
      </div>
      <div class="controls">
        <button id="startBtn" class="tiny">Start Camera</button>
        <button id="stopBtn" class="tiny ghost">Stop</button>
        <button id="manualBtn" class="tiny ghost">Manual Entry</button>
      </div>
    </div>

    <div style="margin-top:10px" class="row">
      <video id="video" autoplay muted playsinline></video>
      <div style="width:100%;max-width:420px">
        <div class="info">
          <div style="display:flex;justify-content:space-between;align-items:center">
            <div>
              <div class="small muted">Last scanned enrollment</div>
              <div id="lastEnrollment" style="font-size:18px;font-weight:700">—</div>
              <div id="lastName" class="small muted">—</div>
            </div>
            <div style="text-align:right">
              <div class="small muted">Status</div>
              <div id="lastStatus" style="font-size:16px;margin-top:4px">—</div>
            </div>
          </div>

          <div style="margin-top:8px;display:flex;gap:8px">
            <button id="registerBtn" class="tiny" disabled>Register Vote</button>
            <button id="undoBtn" class="tiny ghost" disabled>Undo Last</button>
            <button id="exportBtn" class="tiny ghost">Export Audit CSV</button>
          </div>

          <div style="margin-top:8px" class="small muted">Audit log (most recent 10)</div>
          <div id="auditPreview" style="max-height:220px;overflow:auto;margin-top:8px"></div>
        </div>
      </div>
    </div>
  </section>

  <section class="card">
    <div style="display:flex;justify-content:space-between;align-items:center">
      <div>
        <div class="small">Voter list (first 100 shown)</div>
        <div class="small muted">You must upload the full department list to check eligibility.</div>
      </div>
      <div>
        <button id="downloadVoters" class="tiny ghost">Download Voters CSV</button>
      </div>
    </div>

    <div id="voterTableWrap" style="margin-top:10px;overflow:auto;max-height:300px">
      <table id="voterTable">
        <thead><tr><th>Enrollment</th><th>Name</th><th>Dept</th><th>Eligible</th><th>Voted</th><th>VotedTime</th></tr></thead>
        <tbody></tbody>
      </table>
    </div>
  </section>

  <footer>
    <div class="small muted">Tips: Use 1D barcode or QR that encodes the enrollment number. If camera scanning misses codes, try good lighting & hold camera steady. For multiple booths, copy the page and set Booth-1/Booth-2.</div>
  </footer>
</div>

<script>
/* Election Scanner single-file app
 * - Uses @zxing/library for camera barcode scanning
 * - Uses PapaParse for CSV import/export
 * - Stores voters & audit in browser localStorage (so data persists on that device)
 * - You can export audit as CSV and merge across booths after election
 */

const STORAGE_VOTERS_KEY = 'election_voters_v1';
const STORAGE_AUDIT_KEY = 'election_audit_v1';
const STORAGE_LAST_KEY = 'election_last_v1';

let codeReader = null;
let selectedDeviceId = null;
let scanning = false;
let videoElem = document.getElementById('video');
let lastScanned = null;

// Helpers: localStorage load/save
function saveVoters(obj){ localStorage.setItem(STORAGE_VOTERS_KEY, JSON.stringify(obj)); }
function loadVoters(){ try{ return JSON.parse(localStorage.getItem(STORAGE_VOTERS_KEY) || '{}'); }catch(e){ return {}; } }
function saveAudit(a){ localStorage.setItem(STORAGE_AUDIT_KEY, JSON.stringify(a)); }
function loadAudit(){ try{ return JSON.parse(localStorage.getItem(STORAGE_AUDIT_KEY) || '[]'); }catch(e){ return []; } }
function saveLast(l){ localStorage.setItem(STORAGE_LAST_KEY, JSON.stringify(l)); }
function loadLast(){ try{ return JSON.parse(localStorage.getItem(STORAGE_LAST_KEY) || 'null'); }catch(e){ return null; } }

// Render table & audit preview
function renderVoterTable(){
  const voters = loadVoters();
  const tbody = document.querySelector('#voterTable tbody');
  tbody.innerHTML = '';
  const keys = Object.keys(voters).slice(0,100);
  for(const k of keys){
    const v = voters[k];
    const tr = document.createElement('tr');
    tr.innerHTML = `<td>${k}</td><td>${escapeHtml(v.Name||'—')}</td><td>${escapeHtml(v.Dept||'—')}</td><td>${v.Eligible? 'Yes':'No'}</td><td>${v.Voted? 'Yes':'No'}</td><td>${v.VotedTime? v.VotedTime : ''}</td>`;
    tbody.appendChild(tr);
  }
}

function renderAuditPreview(){
  const audit = loadAudit();
  const wrap = document.getElementById('auditPreview');
  wrap.innerHTML = '';
  audit.slice(-10).reverse().forEach(row=>{
    const d = document.createElement('div');
    d.style.padding = '6px 6px';
    d.style.borderBottom = '1px dashed rgba(255,255,255,0.03)';
    d.innerHTML = `<div style="font-weight:700">${row.enrollment} — <span class="small muted">${row.action}</span></div><div class="small muted">${row.timestamp} · ${row.scanner || ''} ${row.operator? '· '+row.operator:''}</div>`;
    wrap.appendChild(d);
  });
}

// CSV import
document.getElementById('fileInput').addEventListener('change', (e)=>{
  const f = e.target.files[0];
  if(!f) return;
  Papa.parse(f, {
    header: true,
    skipEmptyLines: true,
    complete: function(results){
      const data = results.data;
      const voters = loadVoters();
      let count=0;
      data.forEach(row=>{
        const en = (row.Enrollment || row.enrollment || '').toString().trim();
        if(!en) return;
        voters[en] = {
          Enrollment: en,
          Name: row.Name || row.name || '',
          Dept: row.Dept || row.dept || '',
          Eligible: (String(row.Eligible||row.eligible||'true').toLowerCase()!=='false'),
          Voted: (String(row.Voted||row.voted||'false').toLowerCase()==='true'),
          VotedTime: row.VotedTime || row.votedtime || '',
          ScannerID: row.ScannerID || row.scannerid || '',
          Notes: row.Notes || row.notes || ''
        };
        count++;
      });
      saveVoters(voters);
      renderVoterTable();
      alert('Loaded ' + count + ' voters.');
      e.target.value = '';
    }, error: function(err){ alert('CSV parse error: ' + err); }
  });
});

// Sample CSV for quick load
document.getElementById('loadSample').addEventListener('click', ()=>{
  const sample = `Enrollment,Name,Dept,Eligible,Voted,VotedTime,ScannerID,Notes
20190001,Rahul Sharma,Commerce,TRUE,FALSE,,
20190002,Priya Verma,Commerce,TRUE,FALSE,,
20190003,Suman Negi,Commerce,TRUE,FALSE,,
20190004,Ankit Singh,Commerce,FALSE,FALSE,,
20190005,Esha Kapoor,Commerce,TRUE,FALSE,,`;
  Papa.parse(sample, {header:true,skipEmptyLines:true,complete:function(res){
    const voters = loadVoters();
    res.data.forEach(row=>{
      const en = (row.Enrollment || '').toString().trim(); if(!en) return;
      voters[en] = { Enrollment: en, Name: row.Name, Dept: row.Dept, Eligible: String(row.Eligible).toLowerCase()!=='false', Voted:false, VotedTime:'', ScannerID:'', Notes:'' };
    });
    saveVoters(voters); renderVoterTable(); alert('Sample voters loaded (edit as needed).');
  }});
});

// Clear data
document.getElementById('clearData').addEventListener('click', ()=>{
  if(!confirm('Clear all stored voter & audit data on THIS DEVICE?')) return;
  localStorage.removeItem(STORAGE_VOTERS_KEY); localStorage.removeItem(STORAGE_AUDIT_KEY); localStorage.removeItem(STORAGE_LAST_KEY);
  renderVoterTable(); renderAuditPreview();
  alert('Cleared local data.');
});

// Start camera scanning
document.getElementById('startBtn').addEventListener('click', async ()=>{
  if(scanning) return;
  try{
    codeReader = new ZXing.BrowserMultiFormatReader();
    const hints = null;
    const devices = await ZXing.BrowserBarcodeReader.listVideoInputDevices();
    // pick back camera if possible
    let chosen = devices.find(d => /back|rear|environment/i.test(d.label)) || devices[0];
    if(!chosen) chosen = devices[0];
    selectedDeviceId = chosen ? chosen.deviceId : null;
    const previewElem = videoElem;
    codeReader.decodeFromVideoDevice(selectedDeviceId, previewElem, (result, err) => {
      if(result){
        handleScannedText(result.getText());
      }
      if(err && !(err instanceof ZXing.NotFoundException)) {
        // console.debug(err);
      }
    });
    scanning = true;
    document.getElementById('startBtn').disabled = true;
    document.getElementById('stopBtn').disabled = false;
  } catch(e){
    alert('Camera start failed: ' + e);
  }
});

// Stop camera
document.getElementById('stopBtn').addEventListener('click', ()=>{
  if(codeReader){
    codeReader.reset();
    codeReader = null;
  }
  videoElem.srcObject = null;
  scanning = false;
  document.getElementById('startBtn').disabled = false;
  document.getElementById('stopBtn').disabled = true;
});

// Manual entry
document.getElementById('manualBtn').addEventListener('click', ()=>{
  const en = prompt('Enter Enrollment (manual):');
  if(en) handleScannedText(en.trim());
});

// Handle scanned enrollment string
function handleScannedText(text){
  // if barcode encodes extra data (e.g., "ENR:2019001" or a URL), try to extract enrollment by digits
  const maybe = extractEnrollmentFromText(text);
  const enrollment = maybe || text.trim();
  lastScanned = { enrollment, raw: text, when: new Date().toISOString() };
  saveLast(lastScanned);
  showLastScanned();
  // If auto-register on scan desired, you could call registerVote() here.
}

// Extract digits (best-effort): returns first 6-12 digit chunk
function extractEnrollmentFromText(t){
  if(!t) return null;
  // common patterns: pure enrollment digits, or prefixed like "ENR:2019001", or URL with param ?id=2019001
  const digitMatches = t.match(/\d{5,12}/g);
  if(digitMatches && digitMatches.length) return digitMatches[0];
  return null;
}

// Show last scanned details & status
function showLastScanned(){
  const last = loadLast();
  const el = document.getElementById('lastEnrollment');
  const nameEl = document.getElementById('lastName');
  const statusEl = document.getElementById('lastStatus');
  const regBtn = document.getElementById('registerBtn');
  const undoBtn = document.getElementById('undoBtn');

  if(!last){ el.textContent = '—'; nameEl.textContent = '—'; statusEl.textContent = '—'; regBtn.disabled = true; undoBtn.disabled = true; return; }
  el.textContent = last.enrollment || last.raw;
  const voters = loadVoters();
  const v = voters[last.enrollment];
  if(!v){
    nameEl.textContent = 'NOT FOUND in list';
    statusEl.innerHTML = `<span class="status-no">Not registered / Not eligible</span>`;
    regBtn.disabled = true;
    undoBtn.disabled = true;
  } else {
    nameEl.textContent = v.Name || '';
    if(!v.Eligible){
      statusEl.innerHTML = `<span class="status-no">Not eligible</span>`;
      regBtn.disabled = true;
      undoBtn.disabled = true;
    } else if(v.Voted){
      statusEl.innerHTML = `<span class="status-no">Already scanned at ${v.VotedTime}</span>`;
      regBtn.disabled = true;
      undoBtn.disabled = false;
    } else {
      statusEl.innerHTML = `<span class="status-ok">Eligible — Not yet scanned</span>`;
      regBtn.disabled = false;
      undoBtn.disabled = true;
    }
  }
}

// Register vote action (mark voter as voted & append audit)
document.getElementById('registerBtn').addEventListener('click', ()=>{
  const last = loadLast();
  if(!last) return alert('No enrollment scanned.');
  const voters = loadVoters();
  const v = voters[last.enrollment];
  if(!v) return alert('Enrollment not found in uploaded list.');
  if(!v.Eligible) return alert('Student not eligible.');
  if(v.Voted) return alert('Already scanned.');

  // mark voted
  v.Voted = true;
  v.VotedTime = new Date().toLocaleString();
  v.ScannerID = document.getElementById('boothId').value || v.ScannerID || '';
  v.Notes = (v.Notes || '') + (v.Notes? ' | ':'') + 'Scanned via device';
  voters[last.enrollment] = v;
  saveVoters(voters);

  // audit
  const audit = loadAudit();
  const operator = (typeof navigator !== 'undefined' && navigator.userAgent) ? (navigator.userAgent.split(')')[0] || '') : '';
  audit.push({ enrollment: last.enrollment, action: 'VOTED', timestamp: new Date().toLocaleString(), scanner: document.getElementById('boothId').value || '', operator });
  saveAudit(audit);

  renderVoterTable(); renderAuditPreview(); showLastScanned();
  alert('Vote registered for ' + last.enrollment + (v.Name ? ' — ' + v.Name : ''));
});

// Undo last (only if already voted) — simple revert of the last audit entry for that enrollment
document.getElementById('undoBtn').addEventListener('click', ()=>{
  const last = loadLast();
  if(!last) return;
  const voters = loadVoters();
  const v = voters[last.enrollment];
  if(!v || !v.Voted) return alert('No recorded vote to undo for this enrollment.');
  if(!confirm('Undo the vote registration for ' + last.enrollment + '?')) return;
  v.Voted = false; v.VotedTime = ''; voters[last.enrollment] = v; saveVoters(voters);
  const audit = loadAudit();
  // remove last matching audit row
  for(let i=audit.length-1;i>=0;i--){
    if(audit[i].enrollment === last.enrollment && audit[i].action === 'VOTED'){ audit.splice(i,1); break; }
  }
  saveAudit(audit);
  renderVoterTable(); renderAuditPreview(); showLastScanned();
  alert('Vote undone for ' + last.enrollment);
});

// Export audit CSV
document.getElementById('exportBtn').addEventListener('click', ()=>{
  const audit = loadAudit();
  if(!audit.length) return alert('No audit data to export.');
  const csv = Papa.unparse(audit);
  downloadText('audit_export.csv', csv);
});

// Download voters CSV (current stored)
document.getElementById('downloadVoters').addEventListener('click', ()=>{
  const voters = loadVoters();
  const arr = Object.keys(voters).map(k => voters[k]);
  const csv = Papa.unparse(arr);
  downloadText('voters_export.csv', csv);
});

// Utility: download text file
function downloadText(filename, text){
  const blob = new Blob([text], {type: 'text/csv;charset=utf-8;'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url; a.download = filename; document.body.appendChild(a); a.click();
  setTimeout(()=>{ URL.revokeObjectURL(url); a.remove(); }, 200);
}

// small helper
function escapeHtml(s){ if(!s) return ''; return String(s).replace(/[&<>"']/g, function(m){ return {'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m];}); }

// Init: load UI state
renderVoterTable(); renderAuditPreview(); showLastScanned();
</script>
</body>
</html>
